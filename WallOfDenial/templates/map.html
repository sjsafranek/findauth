{% extends "base.html" %}
{% block head_scripts %}

        <!--  Leaflet.draw-master  -->
        <script src="/static/leaflet.js"></script>
        <link rel="stylesheet" href="/static/leaflet.css" />

        <!-- D3 and JQuery -->
        <script src="/static/js/jquery-1.11.0.js"></script>  <!-- | JQUERY -->
        <!-- <script src="/static/js/jquery-ui-1.11.4.js"></script> -->  <!-- JQUERY UI -->
        <script src = "/static/js/d3.js"></script>

        <!-- LOCATE CONTROL -->
        <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

        <!-- HEAT MAP -->
    <!--
        <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.0/leaflet-heat.js'></script>
    -->
        <!-- <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-heat/v0.1.3/leaflet-heat.js'></script> -->

        <!-- Font Awesome CSS -->
        <link rel="stylesheet" href="/static/font-awesome-4.3.0/css/font-awesome.min.css">


        <link rel="stylesheet" href="/static/mapClient.css" />       


{% endblock %}
{% block content %}

        {% csrf_token %}

        <div class="container-fluid">
            <div class="row">
                <div id='map'> </div>
            </div>
        </div>

        <script>

            var map;

            var servers = {{ servers|safe }};

            var group = "{{ group|safe}}";
            var username = "{{ username|safe }}";

            $(function(){
                
                map = L.map('map', {maxZoom: 22});

                L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png',{ 
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a> | F.I.N.D.'
                }).addTo(map);

                map.setView( [0,0], 1 );

            });



var current_location_marker = false;
var timer;
var trackingLocations = {};
var trackingUsers = {};

function getFeature(datasource, k){
//     $.getJSON(
//         servers.gis.address + "/api/v1/layer/" + datasource + "/feature/" + k, {
//         apikey: servers.gis.apikey
//     }, 
//     function(data) {
//         console.log(data);
//     });
//     // return results;
        var results;
        $.ajax({
            crossDomain: true,
            type: "GET",
            async: false,
            url:  servers.gis.address + "/api/v1/layer/" + datasource + "/feature/" + k + "?apikey=" + servers.gis.apikey,
            dataType: 'JSON',
            success: function (data) {
                try {
                    results = data;
                }
                catch(err){  console.log('Error:', err);  }
            },
            error: function(xhr,errmsg,err) {
                console.log(xhr.status,xhr.responseText,errmsg,err);
                var message = "status: " + xhr.status + "<br>";
                message += "responseText: " + xhr.responseText + "<br>";
                message += "errmsg: " + errmsg + "<br>";
                message += "Error:" + err;
                alert(message);
            }
        });
        return results;
}

function startTracking() {
    timer = window.setInterval(function() {
        // $.getJSON(
        //     servers.ml + '/userlocs', {
        //     group: servers.gis.apikey
        // }, 
        // function(data) {
        //     console.log(data);
        // });

        $.ajax({
            crossDomain: true,
            type: "GET",
            async: false,
            url:  servers.ml + '/userlocs?group=' + servers.gis.apikey,
            dataType: 'JSON',
            success: function (data) {
                try {
                    for (var user in data.users) {
                        var userLoc = data.users[user].location;
                        // locations
                        if(!trackingLocations.hasOwnProperty(userLoc)) {
                            var lyr = userLoc.split(":")[0];
                            var feat = userLoc.split(":")[1];
                            var feature = getFeature(lyr, feat);
                            trackingLocations[userLoc] = feature;
                        }
                        // users
                        if(!trackingUsers.hasOwnProperty(user)) {
                            console.log(trackingLocations[userLoc].coordinates);
                            trackingUsers[user] = L.marker(
                                trackingLocations[userLoc].coordinates
                            ).addTo(map).bindPopup(
                                trackingLocations[userLoc].properties.name
                            );
                        }
                        trackingUsers[user] = location;

                    }
                }
                catch(err){  console.log('Error:', err);  }
            },
            error: function(xhr,errmsg,err) {
                console.log(xhr.status,xhr.responseText,errmsg,err);
                var message = "status: " + xhr.status + "<br>";
                message += "responseText: " + xhr.responseText + "<br>";
                message += "errmsg: " + errmsg + "<br>";
                message += "Error:" + err;
                alert(message);
            }
        });





    }, 1000);
}

function stopTracking(){
    window.clearInterval(timer);
}

$(function(){
    $("#track").on('change', function() {
        if ($("#track")[0].checked) {
            startTracking();
        }
        else {
            stopTracking();
        }
    });
})








            $("#ml").click(function(){
              var layer = $(this).closest("li").attr("id");
              var url = servers.ml + "/dashboard/" + servers.gis.apikey;
              console.log("view:", url);
              window.open(url, '_blank');
            }).css('cursor', 'pointer');


        </script>

{% endblock %}

